# filename: ansible/roles/pi_log/tasks/main.yml
---

- name: Ensure /opt/pi-log exists
  ansible.builtin.file:
    path: /opt/pi-log
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Blow out contents of /opt/pi-log
  ansible.builtin.file:
    path: /opt/pi-log
    state: directory
    owner: root
    group: root
    mode: "0755"
    recurse: true

- name: Recreate /opt/pi-log after blowout
  ansible.builtin.file:
    path: /opt/pi-log
    state: directory
    owner: root
    group: root
    mode: "0755"

# Canonical repo sync â€” the ONLY sync
- name: Sync application source to /opt/pi-log
  ansible.posix.synchronize:
    src: "{{ playbook_dir | dirname }}/"
    dest: /opt/pi-log
    delete: true
    rsync_opts:
      - "--exclude=/.git/"
      - "--exclude=/.github/"
      - "--exclude=/.venv/"
      - "--exclude=/ansible/"
      - "--exclude=/molecule/"
      - "--exclude=/tests/"
      - "--exclude=__pycache__"
      - "--exclude=*.pyc"
      - "--exclude=*.pyo"
      - "--exclude=.pytest_cache"
      - "--exclude=.mypy_cache"
      - "--exclude=.ruff_cache"
      - "--exclude=*.swp"
      - "--exclude=*.swo"
      - "--exclude=.DS_Store"
      - "--exclude=*.log"

- name: Ensure config directory exists
  ansible.builtin.file:
    path: /etc/pi-log
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy config.toml
  ansible.builtin.template:
    src: config.toml.j2
    dest: /etc/pi-log/config.toml
    owner: root
    group: root
    mode: "0644"
  notify: Restart pi-log service

- name: Ensure virtual environment exists
  ansible.builtin.command:
    cmd: python3.11 -m venv /opt/pi-log/.venv
    creates: /opt/pi-log/.venv/bin/activate

- name: Install Python dependencies
  ansible.builtin.pip:
    requirements: /opt/pi-log/requirements.txt
    virtualenv: /opt/pi-log/.venv
  notify: Restart pi-log service

- name: Deploy systemd service
  ansible.builtin.template:
    src: pi-log.service.j2
    dest: /etc/systemd/system/pi-log.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart pi-log service

- name: Restart pi-log service after deploy
  ansible.builtin.systemd:
    name: pi-log
    state: restarted
    enabled: true

# -------------------------
# Handlers
# -------------------------
- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: true

- name: Restart pi-log service
  ansible.builtin.systemd:
    name: pi-log
    enabled: true
    state: restarted
