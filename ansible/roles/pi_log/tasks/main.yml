# filename: ansible/roles/pi_log/tasks/main.yml
---
- name: Ensure pi-log directory exists
  ansible.builtin.file:
    path: /opt/pi-log
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure config directory exists
  ansible.builtin.file:
    path: /etc/pi-log
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy config.toml
  ansible.builtin.template:
    src: config.toml.j2
    dest: /etc/pi-log/config.toml
    owner: root
    group: root
    mode: "0644"

- name: Deploy systemd service
  ansible.builtin.template:
    src: pi-log.service.j2
    dest: /etc/systemd/system/pi-log.service
    owner: root
    group: root
    mode: "0644"

- name: Install pi-log Python package
  ansible.builtin.pip:
    name: /opt/pi-log
    editable: true

- name: Copy pi-log executable wrapper
  ansible.builtin.copy:
    src: pi-log.sh
    dest: /usr/local/bin/pi-log
    mode: "0755"

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable pi-log service
  ansible.builtin.systemd:
    name: pi-log
    enabled: true

- name: Start pi-log service
  ansible.builtin.systemd:
    name: pi-log
    state: started
